---
import { readFile } from "node:fs/promises";
import { resolve } from "node:path";
import type { GetStaticPathsOptions, Page } from "astro";
import { Octokit } from "@octokit/rest";
import matter from "gray-matter";

import { cn } from "@/lib/utils";
import Footer from "@/components/layout/footer.astro";
import Layout from "@/components/layout/layout.astro";
import Nav from "@/components/layout/nav.astro";
import ReleaseArticle from "@/components/release-article.astro";
import Title from "@/components/title.astro";

interface Release {
  version: string;
  date: string;
  body: string;
  url: string;
  isPrerelease: boolean;
  tagName: string;
  override?: OverrideFrontmatter | null;
}

interface OverrideFrontmatter {
  mode?: "replace" | "prefix" | "suffix" | "extend";
  image?: string;
  imageAlt?: string;
}

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const RELEASES_PER_PAGE = 10;

  // Helper function to check if a version is a patch (x.x.1+)
  const isPatchVersion = (version: string): boolean => {
    const match = version.match(/^v?(\d+)\.(\d+)\.(\d+)/);
    if (!match) return false;
    const [, , , patch] = match;
    return parseInt(patch) > 0;
  };

  // Helper function to load override content if exists
  const loadOverride = async (version: string) => {
    try {
      const overridePath = resolve(
        process.cwd(),
        "src/content/changelog-overrides",
        `${version}.md`,
      );
      const fileContent = await readFile(overridePath, "utf-8");
      const { data, content } = matter(fileContent);
      return {
        content,
        frontmatter: data as OverrideFrontmatter,
      };
    } catch {
      return null;
    }
  };

  const octokit = new Octokit({
    auth: import.meta.env.GITHUB_TOKEN,
  });

  // Fetch all releases
  const { data: allReleases } = await octokit.repos.listReleases({
    owner: "michaelheckmann",
    repo: "orbit-releases",
    per_page: 100,
  });

  // Filter out pre-releases and patch versions
  const filteredReleases = await Promise.all(
    allReleases
      .filter((release) => !release.prerelease)
      .filter((release) => !isPatchVersion(release.tag_name))
      .map(async (release) => {
        const override = await loadOverride(release.tag_name);
        let finalBody = release.body || "";

        // Apply override based on mode
        if (override) {
          const mode = override.frontmatter.mode || "prefix";
          switch (mode) {
            case "replace":
              finalBody = override.content;
              break;
            case "prefix":
              finalBody = `${override.content}\n\n${finalBody}`;
              break;
            case "suffix":
              finalBody = `${finalBody}\n\n${override.content}`;
              break;
            case "extend":
              finalBody = `${override.content}\n\n---\n\n${finalBody}`;
              break;
          }
        }

        return {
          version: release.tag_name,
          date: release.published_at || release.created_at,
          body: finalBody,
          url: release.html_url,
          isPrerelease: release.prerelease,
          tagName: release.tag_name,
          override: override?.frontmatter || null,
        };
      }),
  );

  return paginate(filteredReleases, { pageSize: RELEASES_PER_PAGE });
}

interface Props {
  page: Page<Release>;
}

const { page } = Astro.props;
---

<Layout
  title="Orbit â€“ Updates"
  description="View the full list of updates to Orbit for Mac. See all major and minor releases with detailed notes about new features, improvements, and changes."
>
  <Nav />
  <section class={cn("mx-auto max-w-4xl px-6", "py-24")}>
    <div class="pb-16">
      <Title
        eyebrow="Product Updates"
        title="What's new?"
        subtitle="Browse the updates I've shipped and see what's new. Your feedback drives these improvements and helps make Orbit better for everyone. <a href='https://x.com/mt_heckmann' target='_blank' rel='noopener'>Follow me on X</a> for more frequent updates."
      />
    </div>

    <div class="space-y-12">
      {page.data.map((release) => <ReleaseArticle release={release} />)}
    </div>

    <!-- Pagination -->
    {
      (page.url.prev || page.url.next) && (
        <nav
          class="mt-16 flex items-center justify-between border-t border-neutral-800 pt-8"
          aria-label="Pagination"
        >
          <div class="flex-1">
            {page.url.prev && (
              <a
                href={page.url.prev}
                class={cn(
                  "inline-flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2",
                  "text-sm text-neutral-300 transition-colors",
                  "hover:bg-neutral-800 hover:text-neutral-100",
                  "focus-visible:ring-2 focus-visible:ring-neutral-500 focus-visible:outline-none",
                )}
              >
                <svg
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
                Previous
              </a>
            )}
          </div>
          <div class="flex items-center gap-2 text-sm text-neutral-500">
            <span>
              Page {page.currentPage} of {page.lastPage}
            </span>
          </div>
          <div class="flex flex-1 justify-end">
            {page.url.next && (
              <a
                href={page.url.next}
                class={cn(
                  "inline-flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900 px-4 py-2",
                  "text-sm text-neutral-300 transition-colors",
                  "hover:bg-neutral-800 hover:text-neutral-100",
                  "focus-visible:ring-2 focus-visible:ring-neutral-500 focus-visible:outline-none",
                )}
              >
                Next
                <svg
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            )}
          </div>
        </nav>
      )
    }
  </section>
  <Footer />
</Layout>
